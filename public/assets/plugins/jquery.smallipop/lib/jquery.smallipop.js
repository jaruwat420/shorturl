// Generated by CoffeeScript 1.3.3
/*!
Smallipop (10/14/2012)
Copyright (c) 2011-2012 Small Improvements (http://www.small-improvements.com)

Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) license.

@author Sebastian Helzle (sebastian@helzle.net)
*/

(function($) {
  $.smallipop = {
    version: '0.2.1',
    defaults: {
      contentAnimationSpeed: 150,
      cssAnimations: {
        enabled: false,
        show: 'animated fadeIn',
        hide: 'animated fadeOut'
      },
      funcEase: 'easeInOutQuad',
      handleInputs: true,
      hideTrigger: false,
      hideOnPopupClick: true,
      hideOnTriggerClick: true,
      horizontal: false,
      infoClass: 'smallipopHint',
      invertAnimation: false,
      popupOffset: 31,
      popupYOffset: 0,
      popupDistance: 20,
      popupDelay: 100,
      popupAnimationSpeed: 200,
      preferredPosition: 'top',
      theme: 'default',
      touchSupport: true,
      triggerAnimationSpeed: 150,
      triggerOnClick: false,
      onAfterHide: null,
      onAfterShow: null,
      onBeforeHide: null,
      onBeforeShow: null,
      windowPadding: 30
    },
    popup: null,
    lastId: 1,
    _hideSmallipop: function(e) {
      var direction, popup, shownId, sip, target, trigger, triggerOptions, xDistance, yDistance, _ref;
      sip = $.smallipop;
      popup = sip.popup;
      shownId = popup.data('shown');
      target = (e != null ? e.target : void 0) ? $(e.target) : null;
      trigger = $(".smallipop" + shownId);
      triggerOptions = ((_ref = trigger.data('smallipop')) != null ? _ref.options : void 0) || sip.defaults;
      if (target && trigger.length && (e != null ? e.type : void 0) === 'click' && ((!triggerOptions.hideOnTriggerClick && target.is(trigger)) || (!triggerOptions.hideOnPopupClick && popup.find(target).length))) {
        return;
      }
      if (shownId && triggerOptions.hideTrigger) {
        trigger.stop(true).fadeTo(triggerOptions.triggerAnimationSpeed, 1);
      }
      direction = triggerOptions.invertAnimation ? -1 : 1;
      xDistance = sip.popup.data('xDistance') * direction;
      yDistance = sip.popup.data('yDistance') * direction;
      popup.data({
        hideDelayTimer: null,
        beingShown: false
      });
      if (triggerOptions.cssAnimations.enabled) {
        popup.removeClass(triggerOptions.cssAnimations.show).addClass(triggerOptions.cssAnimations.hide).data('shown', '');
        return typeof triggerOptions.onAfterHide === "function" ? triggerOptions.onAfterHide() : void 0;
      } else {
        return popup.stop(true).animate({
          top: "-=" + xDistance + "px",
          left: "+=" + yDistance + "px",
          opacity: 0
        }, triggerOptions.popupAnimationSpeed, triggerOptions.funcEase, function() {
          var tip;
          tip = $(this);
          if (!tip.data('beingShown')) {
            tip.css('display', 'none').data('shown', '');
          }
          return typeof triggerOptions.onAfterHide === "function" ? triggerOptions.onAfterHide() : void 0;
        });
      }
    },
    _showSmallipop: function(e) {
      var self, sip, triggerData, _ref;
      sip = $.smallipop;
      self = $(this);
      triggerData = self.data('smallipop');
      if (sip.popup.data('shown') !== triggerData.id && ((_ref = !triggerData.type) === 'checkbox' || _ref === 'radio')) {
        if (e != null) {
          e.preventDefault();
        }
      }
      return sip._triggerMouseover.call(this);
    },
    onTouchDevice: function() {
      return typeof Modernizr !== "undefined" && Modernizr !== null ? Modernizr.touch : void 0;
    },
    killTimers: function() {
      var hideTimer, popup, showTimer;
      popup = $.smallipop.popup;
      hideTimer = popup.data('hideDelayTimer');
      showTimer = popup.data('showDelayTimer');
      if (hideTimer) {
        clearTimeout(hideTimer);
      }
      if (showTimer) {
        return clearTimeout(showTimer);
      }
    },
    refreshPosition: function() {
      var animationTarget, beingShown, cssTarget, offset, options, popup, popupCenter, popupDistanceBottom, popupDistanceLeft, popupDistanceRight, popupDistanceTop, popupH, popupOffsetLeft, popupOffsetTop, popupW, popupY, selfHeight, selfWidth, selfY, shownId, sip, trigger, win, winHeight, winWidth, windowPadding, xDistance, yDistance, yOffset;
      sip = $.smallipop;
      popup = sip.popup;
      shownId = popup.data('shown');
      if (!shownId) {
        return;
      }
      trigger = $(".smallipop" + shownId);
      options = trigger.data('smallipop').options;
      popup.removeClass().addClass(options.theme);
      win = $(window);
      xDistance = yDistance = options.popupDistance;
      yOffset = options.popupYOffset;
      offset = trigger.offset();
      popupH = popup.outerHeight();
      popupW = popup.outerWidth();
      popupCenter = popupW / 2;
      winWidth = win.width();
      winHeight = win.height();
      windowPadding = options.windowPadding;
      selfWidth = trigger.outerWidth();
      selfHeight = trigger.outerHeight();
      selfY = offset.top - win.scrollTop();
      popupOffsetLeft = offset.left + selfWidth / 2;
      popupOffsetTop = offset.top - popupH + yOffset;
      popupY = popupH + options.popupDistance - yOffset;
      popupDistanceTop = selfY - popupY;
      popupDistanceBottom = winHeight - selfY - selfHeight - popupY;
      popupDistanceLeft = offset.left - popupW - options.popupOffset;
      popupDistanceRight = winWidth - offset.left - selfWidth - popupW;
      if (options.horizontal) {
        xDistance = 0;
        popupOffsetTop += selfHeight / 2 + popupH / 2;
        if ((options.preferredPosition === 'left' && popupDistanceLeft > windowPadding) || popupDistanceRight < windowPadding) {
          popup.addClass('sipPositionedLeft');
          popupOffsetLeft = offset.left - popupW - options.popupOffset;
          yDistance = -yDistance;
        } else {
          popup.addClass('sipPositionedRight');
          popupOffsetLeft = offset.left + selfWidth + options.popupOffset;
        }
      } else {
        yDistance = 0;
        if (popupOffsetLeft + popupCenter > winWidth - windowPadding) {
          popupOffsetLeft -= popupCenter * 2 - options.popupOffset;
          popup.addClass('sipAlignLeft');
        } else if (popupOffsetLeft - popupCenter < windowPadding) {
          popupOffsetLeft -= options.popupOffset;
          popup.addClass('sipAlignRight');
        } else {
          popupOffsetLeft -= popupCenter;
        }
        if ((options.preferredPosition === 'bottom' && popupDistanceBottom > windowPadding) || popupDistanceTop < windowPadding) {
          popupOffsetTop += popupH + selfHeight - 2 * yOffset;
          xDistance = -xDistance;
          yOffset = 0;
          popup.addClass('sipAlignBottom');
        }
      }
      if (options.hideTrigger) {
        trigger.stop(true).fadeTo(options.triggerAnimationSpeed, 0);
      }
      beingShown = popup.data('beingShown');
      if (!beingShown || options.cssAnimations.enabled) {
        popupOffsetTop -= xDistance;
        popupOffsetLeft += yDistance;
        xDistance = 0;
        yDistance = 0;
      }
      popup.data({
        xDistance: xDistance,
        yDistance: yDistance
      });
      cssTarget = {
        top: popupOffsetTop,
        left: popupOffsetLeft,
        display: 'block',
        opacity: beingShown && !options.cssAnimations.enabled ? 0 : 1
      };
      animationTarget = {
        top: "-=" + xDistance + "px",
        left: "+=" + yDistance + "px",
        opacity: 1
      };
      if (options.cssAnimations.enabled) {
        popup.addClass(options.cssAnimations.show).css(cssTarget);
        if (beingShown) {
          popup.data('beingShown', false);
          return typeof options.onAfterShow === "function" ? options.onAfterShow(trigger) : void 0;
        }
      } else {
        return popup.stop(true).css(cssTarget).animate(animationTarget, options.popupAnimationSpeed, options.funcEase, function() {
          if (beingShown) {
            popup.data('beingShown', false);
            return typeof options.onAfterShow === "function" ? options.onAfterShow(trigger) : void 0;
          }
        });
      }
    },
    _getTrigger: function(id) {
      return $(".smallipop" + id);
    },
    _showPopup: function(trigger) {
      var lastTrigger, lastTriggerOpt, popup, shownId, sip, triggerData;
      sip = $.smallipop;
      popup = sip.popup;
      if (!popup.data('triggerHovered')) {
        return;
      }
      triggerData = trigger.data('smallipop');
      shownId = popup.data('shown');
      if (shownId) {
        lastTrigger = sip._getTrigger(shownId);
        lastTriggerOpt = lastTrigger.data('smallipop').options || sip.defaults;
        if (lastTriggerOpt.hideTrigger) {
          lastTrigger.stop(true).fadeTo(lastTriggerOpt.fadeSpeed, 1);
        }
      }
      popup.data({
        beingShown: true,
        shown: triggerData.id
      });
      sip.popupContent.html(triggerData.hint);
      return sip.refreshPosition();
    },
    _triggerMouseover: function() {
      var id, options, popup, self, shownId, sip, _ref;
      self = $(this);
      sip = $.smallipop;
      popup = sip.popup;
      id = (_ref = self.data('smallipop')) != null ? _ref.id : void 0;
      shownId = popup.data('shown');
      sip.killTimers();
      popup.data((id ? 'triggerHovered' : 'hovered'), true);
      if (!id) {
        self = sip._getTrigger(shownId);
        id = shownId;
      }
      if (!self.length) {
        return;
      }
      options = self.data('smallipop').options;
      if (typeof options.onBeforeShow === "function") {
        options.onBeforeShow(self);
      }
      if (shownId !== id) {
        return popup.data('showDelayTimer', setTimeout(function() {
          return sip._showPopup(self);
        }, options.popupDelay));
      }
    },
    _triggerMouseout: function() {
      var id, options, popup, popupData, self, shownId, sip, _ref;
      self = $(this);
      id = (_ref = self.data('smallipop')) != null ? _ref.id : void 0;
      sip = $.smallipop;
      popup = sip.popup;
      popupData = popup.data();
      shownId = popupData.shown;
      sip.killTimers();
      popup.data((id ? 'triggerHovered' : 'hovered'), false);
      if (!id) {
        self = sip._getTrigger(shownId);
      }
      options = self.data('smallipop').options;
      if (typeof options.onBeforeHide === "function") {
        options.onBeforeHide(self);
      }
      if (!(popupData.hovered || popupData.triggerHovered)) {
        return popup.data('hideDelayTimer', setTimeout(sip._hideSmallipop, 500));
      }
    },
    _onWindowResize: function() {
      return $.smallipop.refreshPosition();
    },
    _onWindowClick: function(e) {
      var popup, sip, target;
      sip = $.smallipop;
      popup = sip.popup;
      target = $(e.target);
      if (!(target.is(popup) || target.closest('.sipInitialized').length)) {
        return sip._hideSmallipop(e);
      }
    },
    setContent: function(content) {
      var options, shownId, sip, trigger;
      sip = $.smallipop;
      shownId = sip.popup.data('shown');
      trigger = sip._getTrigger(shownId);
      options = trigger.data('smallipop').options;
      return sip.popupContent.stop(true).fadeTo(options.contentAnimationSpeed, 0, function() {
        sip.popupContent.html(content).fadeTo(options.contentAnimationSpeed, 1);
        return sip.refreshPosition();
      });
    },
    _destroy: function(instances) {
      return instances.each(function() {
        var data, self;
        self = $(this);
        data = self.data('smallipop');
        if (data) {
          return self.unbind('.smallipop').data('smallipop', {}).removeClass("smallipop sipInitialized smallipop" + data.id + " " + data.options.theme);
        }
      });
    },
    _init: function() {
      var popup, sip;
      sip = $.smallipop;
      popup = sip.popup = $('\
          <div id="smallipop">\
            <div class="sipContent"/>\
            <div class="sipArrowBorder"/>\
            <div class="sipArrow"/>\
          </div>\
        ').css('opacity', 0).data({
        xDistance: 0,
        yDistance: 0
      }).bind({
        'mouseover.smallipop': sip._triggerMouseover,
        'mouseout.smallipop': sip._triggerMouseout
      });
      sip.popupContent = popup.find('.sipContent');
      $('body').append(popup);
      popup.delegate('a', 'click.smallipop', sip._hideSmallipop);
      $(document).bind('click.smallipop touchend.smallipop', sip._onWindowClick);
      return $(window).bind('resize.smallipop', sip._onWindowResize);
    }
  };
  /* Add default easing function for smallipop to jQuery if missing
  */

  if (!$.easing.easeInOutQuad) {
    $.easing.easeInOutQuad = function(x, t, b, c, d) {
      if ((t /= d / 2) < 1) {
        return c / 2 * t * t + b;
      } else {
        return -c / 2 * ((--t) * (t - 2) - 1) + b;
      }
    };
  }
  return $.fn.smallipop = function(options, hint) {
    var sip;
    if (options == null) {
      options = {};
    }
    if (hint == null) {
      hint = '';
    }
    sip = $.smallipop;
    if (typeof options === 'string') {
      switch (options.toLowerCase()) {
        case 'show':
          sip._showSmallipop.call(this.first().get(0));
          break;
        case 'hide':
          sip._hideSmallipop();
          break;
        case 'destroy':
          sip._destroy(this);
      }
      return this;
    }
    options = $.extend({}, sip.defaults, options);
    if (options.moveSpeed != null) {
      options.popupAnimationSpeed = options.moveSpeed;
    }
    if (options.hideSpeed != null) {
      options.triggerAnimationSpeed = options.hideSpeed;
    }
    if ((typeof Modernizr !== "undefined" && Modernizr !== null ? Modernizr.cssanimations : void 0) === false) {
      options.cssAnimations.enabled = false;
    }
    if (!sip.popup) {
      sip._init();
    }
    return this.each(function() {
      var isFormElement, newId, objHint, self, tagName, triggerEvents, triggerOptions, type;
      self = $(this);
      tagName = self[0].tagName.toLowerCase();
      type = self.attr('type');
      objHint = hint || self.attr('title') || self.find("." + options.infoClass).html();
      if (objHint && !self.hasClass('sipInitialized')) {
        newId = sip.lastId++;
        triggerOptions = $.extend(true, {}, options);
        triggerEvents = {};
        isFormElement = triggerOptions.handleInputs && (tagName === 'input' || tagName === 'select' || tagName === 'textarea');
        if (isFormElement) {
          triggerOptions.hideOnTriggerClick = false;
          triggerEvents['focus.smallipop'] = sip._triggerMouseover;
          triggerEvents['blur.smallipop'] = sip._triggerMouseout;
        } else {
          triggerEvents['mouseout.smallipop'] = sip._triggerMouseout;
        }
        if (triggerOptions.triggerOnClick || (triggerOptions.touchSupport && sip.onTouchDevice())) {
          triggerEvents['click.smallipop'] = sip._showSmallipop;
        } else {
          triggerEvents['click.smallipop'] = sip._hideSmallipop;
          triggerEvents['mouseover.smallipop'] = sip._triggerMouseover;
        }
        self.addClass("sipInitialized smallipop" + newId).attr('title', '').data('smallipop', {
          id: newId,
          hint: objHint,
          options: triggerOptions,
          tagName: tagName,
          type: type
        }).bind(triggerEvents);
        if (!triggerOptions.hideOnTriggerClick) {
          return self.delegate('a', 'click.smallipop', sip._hideSmallipop);
        }
      }
    });
  };
})(jQuery);
